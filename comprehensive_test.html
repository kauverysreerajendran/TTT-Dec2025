<!DOCTYPE html>
<html>
  <head>
    <title>Comprehensive Rejection Form Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .pass {
        color: green;
        font-weight: bold;
      }
      .fail {
        color: red;
        font-weight: bold;
      }
      .status {
        padding: 5px 10px;
        margin: 5px 0;
        border-radius: 3px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      button {
        margin: 5px;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .proceed {
        background: #28a745;
        color: white;
      }
      .draft {
        background: #007bff;
        color: white;
      }
      .cancel {
        background: #dc3545;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>Rejection Form Validation Test Results</h1>

    <div class="test-section">
      <h2>Test Summary</h2>
      <div id="test-summary"></div>
    </div>

    <div class="test-section">
      <h2>Validation Scenarios</h2>
      <div id="validation-tests"></div>
    </div>

    <div class="test-section">
      <h2>Button State Tests</h2>
      <div id="button-tests">
        <button id="proceedButton" class="proceed">Proceed</button>
        <button id="draftButton" class="draft">Draft</button>
        <button id="cancelButton" class="cancel">Cancel</button>
      </div>
    </div>

    <div class="test-section">
      <h2>Visual Feedback Tests</h2>
      <div id="visual-tests">
        <!-- Simulate rejection form inputs -->
        <table style="width: 100%; border-collapse: collapse">
          <thead>
            <tr>
              <th style="border: 1px solid #ddd; padding: 8px">S.No</th>
              <th style="border: 1px solid #ddd; padding: 8px">ID</th>
              <th style="border: 1px solid #ddd; padding: 8px">Reason</th>
              <th style="border: 1px solid #ddd; padding: 8px">Qty</th>
              <th style="border: 1px solid #ddd; padding: 8px">Tray ID</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px">1</td>
              <td style="border: 1px solid #ddd; padding: 8px">R01</td>
              <td style="border: 1px solid #ddd; padding: 8px">
                VERSION MIXUP
              </td>
              <td style="border: 1px solid #ddd; padding: 8px">
                <input
                  type="number"
                  id="qty1"
                  class="rejection-qty-input"
                  value="14"
                  data-reason-id="R01"
                  style="width: 60px"
                />
              </td>
              <td style="border: 1px solid #ddd; padding: 8px">
                <div style="position: relative">
                  <input
                    type="text"
                    id="tray1"
                    class="rejection-tray-id-input"
                    value="NB-A00001"
                    style="width: 120px; padding: 5px"
                  />
                  <br /><span
                    class="rejection-tray-error"
                    style="font-size: 11px"
                  ></span>
                </div>
              </td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px">2</td>
              <td style="border: 1px solid #ddd; padding: 8px">R02</td>
              <td style="border: 1px solid #ddd; padding: 8px">MODEL MIXUP</td>
              <td style="border: 1px solid #ddd; padding: 8px">
                <input
                  type="number"
                  id="qty2"
                  class="rejection-qty-input"
                  value="2"
                  data-reason-id="R02"
                  style="width: 60px"
                />
              </td>
              <td style="border: 1px solid #ddd; padding: 8px">
                <div style="position: relative">
                  <input
                    type="text"
                    id="tray2"
                    class="rejection-tray-id-input"
                    value="NB-A00001"
                    style="width: 120px; padding: 5px"
                  />
                  <br /><span
                    class="rejection-tray-error"
                    style="font-size: 11px"
                  ></span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
              // Include the fixed validation functions
              const TESTS = {
                  exactMatch: { name: "Exact Match (13+1=14)", qty1: 13, qty2: 1, expected: true },
                  partialUsage: { name: "Partial Usage (12+1=13)", qty1: 12, qty2: 1, expected: false },
                  capacityExceeded: { name: "Capacity Exceeded (10+5=15)", qty1: 10, qty2: 5, expected: false },
                  perfectMatch: { name: "Perfect Reuse (7+7=14)", qty1: 7, qty2: 7, expected: true }
              };

              let testResults = {};

              function validateDuplicateTrayIds() {
                  const duplicates = new Map();
                  const allTrayInputs = document.querySelectorAll('.rejection-tray-id-input');

                  // Clear previous validation
                  allTrayInputs.forEach(input => {
                      if (input._isBackendValidated !== true) {
                          input.classList.remove('duplicate-error', 'duplicate-warning');
                          const errorSpan = input.parentElement?.querySelector('.rejection-tray-error');
                          if (errorSpan) {
                              errorSpan.style.display = 'none';
                              errorSpan.textContent = '';
                          }
                      }
                  });

                  // Collect tray IDs and quantities
                  allTrayInputs.forEach((input, index) => {
                      const trayId = input.value.trim().toUpperCase();

                      if (trayId) {
                          const row = input.closest('tr');
                          const qtyInput = row?.querySelector('.rejection-qty-input');
                          const quantity = qtyInput ? parseInt(qtyInput.value) || 0 : 0;

                          if (!duplicates.has(trayId)) {
                              duplicates.set(trayId, []);
                          }
                          duplicates.get(trayId).push({ input, index, quantity });
                      }
                  });

                  let hasDuplicates = false;

                // ‚úÖ FIXED: Use actual tray quantity instead of capacity
                let trayCapacity = 16; // Default capacity
                let actualTrayQuantity = trayCapacity; // Default to capacity

                // Check if we have backend tray quantity data
                let backendTrayQuantity = null;
                allTrayInputs.forEach(input => {
                  const trayId = input.value.trim().toUpperCase();
                  if (trayId && input._backendTrayQuantity) {
                    backendTrayQuantity = input._backendTrayQuantity;
                  }
                });

                // For testing NB-A00001 simulate it has 14 pieces (not 16)
                if (document.querySelector('.rejection-tray-id-input[value="NB-A00001"]')) {
                  actualTrayQuantity = 14; // Simulated actual quantity
                } else if (backendTrayQuantity !== null) {
                  actualTrayQuantity = backendTrayQuantity;
                }

                console.log(`üîß Testing with actualTrayQuantity: ${actualTrayQuantity}`);
                  // Validate duplicates
                  duplicates.forEach((inputsArray, trayId) => {
                      if (inputsArray.length > 1) {
                          hasDuplicates = true;
                          const totalQuantity = inputsArray.reduce((sum, item) => sum + item.quantity, 0);

      const isExactMatch = totalQuantity === actualTrayQuantity;
                    const isPartialUsage = totalQuantity > 0 && totalQuantity < actualTrayQuantity;
                    const exceedsCapacity = totalQuantity > actualTrayQuantity;

                          inputsArray.forEach(({ input, index, quantity }) => {
                              if (input._isBackendValidated === true) {
                                  return;
                              }

                              const errorSpan = input.parentElement?.querySelector('.rejection-tray-error');

                              if (exceedsCapacity) {
                                  input.classList.add('duplicate-error');
                                  input.style.borderColor = '#dc3545';
                                  input.style.backgroundColor = '#f8d7da';
                                  input._isValid = false;

                                  if (errorSpan) {
                                      errorSpan.innerHTML = `‚ùå Capacity exceeded: ${totalQuantity} pieces > ${trayCapacity} capacity`;
                                      errorSpan.style.display = 'block';
                                      errorSpan.style.color = '#721c24';
                                      errorSpan.style.backgroundColor = '#f8d7da';
                                      errorSpan.style.border = '1px solid #f5c6cb';
                                      errorSpan.style.padding = '4px 6px';
                                      errorSpan.style.borderRadius = '3px';
                                  }
                              } else if (isPartialUsage) {
                                  input.classList.add('duplicate-error');
                                  input.style.borderColor = '#dc3545';
                                  input.style.backgroundColor = '#f8d7da';
                                  input._isValid = false;

                                  if (errorSpan) {
                                      errorSpan.innerHTML = `‚ùå Exact quantity match required: ${totalQuantity}/${trayCapacity} (partial usage blocked)`;
                                      errorSpan.style.display = 'block';
                                      errorSpan.style.color = '#721c24';
                                      errorSpan.style.backgroundColor = '#f8d7da';
                                      errorSpan.style.border = '1px solid #f5c6cb';
                                      errorSpan.style.padding = '4px 6px';
                                      errorSpan.style.borderRadius = '3px';
                                  }
                              } else if (isExactMatch) {
                                  input.classList.add('duplicate-warning');
                                  input.style.borderColor = '#28a745';
                                  input.style.backgroundColor = '#d4edda';
                                  input._isValid = true;

                                  if (errorSpan) {
                                      errorSpan.innerHTML = `‚úÖ Perfect capacity match: ${totalQuantity}/${trayCapacity}`;
                                      errorSpan.style.display = 'block';
                                      errorSpan.style.color = '#155724';
                                      errorSpan.style.backgroundColor = '#d4edda';
                                      errorSpan.style.border = '1px solid #c3e6cb';
                                      errorSpan.style.padding = '4px 6px';
                                      errorSpan.style.borderRadius = '3px';
                                  }
                              }
                          });
                      }
                  });

                  // Return validation result
                  const hasValidationErrors = Array.from(duplicates.values()).some(inputsArray => {
                      if (inputsArray.length > 1) {
                          const totalQuantity = inputsArray.reduce((sum, item) => sum + item.quantity, 0);
                    return totalQuantity !== actualTrayQuantity;

                  return !hasValidationErrors;
              }

              function updateFormValidationState() {
                  const isDuplicateValid = validateDuplicateTrayIds();
                  const proceedButton = document.getElementById('proceedButton');
                  const draftButton = document.getElementById('draftButton');
                  const cancelButton = document.getElementById('cancelButton');

                  // Proceed button state
                  if (proceedButton) {
                      if (!isDuplicateValid) {
                          proceedButton.disabled = true;
                          proceedButton.style.opacity = '0.5';
                          proceedButton.style.cursor = 'not-allowed';
                          proceedButton.title = 'Please fix all invalid tray IDs before proceeding';
                      } else {
                          proceedButton.disabled = false;
                          proceedButton.style.opacity = '1';
                          proceedButton.style.cursor = 'pointer';
                          proceedButton.title = '';
                      }
                  }

                  // Always enable draft and cancel buttons
                  [draftButton, cancelButton].forEach(btn => {
                      if (btn) {
                          btn.disabled = false;
                          btn.style.opacity = '1';
                          btn.style.cursor = 'pointer';
                      }
                  });

                  return isDuplicateValid;
              }

              function runTest(testName, testConfig) {
                  // Set quantities
                  document.getElementById('qty1').value = testConfig.qty1;
                  document.getElementById('qty2').value = testConfig.qty2;

                  // Run validation
                  const validationResult = validateDuplicateTrayIds();
                  const buttonStateResult = updateFormValidationState();

                  // Check visual feedback
                  const trayInputs = document.querySelectorAll('.rejection-tray-id-input');
                  let visualCorrect = true;

                  trayInputs.forEach(input => {
                      const isValid = input._isValid;
                      const borderColor = input.style.borderColor;
                      const bgColor = input.style.backgroundColor;

                      if (testConfig.expected) {
                          // Should be green for valid
                          if (!isValid || borderColor !== 'rgb(40, 167, 69)' || bgColor !== 'rgb(212, 237, 218)') {
                              if (!input._isBackendValidated) visualCorrect = false;
                          }
                      } else {
                          // Should be red for invalid
                          if (isValid !== false || borderColor !== 'rgb(220, 53, 69)' || bgColor !== 'rgb(248, 215, 218)') {
                              if (!input._isBackendValidated) visualCorrect = false;
                          }
                      }
                  });

                  const proceedButton = document.getElementById('proceedButton');
                  const buttonCorrect = proceedButton ? (proceedButton.disabled !== testConfig.expected) : false;

                  return {
                      validation: validationResult === testConfig.expected,
                      buttonState: buttonCorrect,
                      visualFeedback: visualCorrect,
                      overall: (validationResult === testConfig.expected) && buttonCorrect && visualCorrect
                  };
              }

              function displayResults() {
                  // Run all tests
                  Object.keys(TESTS).forEach(testName => {
                      testResults[testName] = runTest(testName, TESTS[testName]);
                  });

                  // Display summary
                  const summary = document.getElementById('test-summary');
                  const passed = Object.values(testResults).filter(r => r.overall).length;
                  const total = Object.keys(testResults).length;

                  summary.innerHTML = `
                      <div class="status ${passed === total ? 'success' : 'error'}">
                          <strong>Test Results: ${passed}/${total} tests passed</strong>
                      </div>
                      ${passed === total ?
                          '<p class="pass">‚úÖ All validation fixes are working correctly!</p>' :
                          '<p class="fail">‚ùå Some tests failed - check individual results below.</p>'
                      }
                  `;

                  // Display detailed results
                  const validationDiv = document.getElementById('validation-tests');
                  validationDiv.innerHTML = Object.keys(testResults).map(testName => {
                      const result = testResults[testName];
                      const config = TESTS[testName];

                      return `
                          <div class="status ${result.overall ? 'success' : 'error'}">
                              <strong>${config.name}</strong><br>
                              <small>
                                  Validation Logic: ${result.validation ? '‚úÖ' : '‚ùå'} |
                                  Button State: ${result.buttonState ? '‚úÖ' : '‚ùå'} |
                                  Visual Feedback: ${result.visualFeedback ? '‚úÖ' : '‚ùå'}
                              </small>
                          </div>
                      `;
                  }).join('');
              }

              // Mock draft loading test
              function testDraftLoading() {
                  // Simulate loading draft with backend validation
                  const trayInput = document.getElementById('tray1');

                  // Mark as backend validated (simulate successful API response)
                  trayInput._isBackendValidated = true;
                  trayInput._isValid = true;
                  trayInput.style.backgroundColor = '#d4edda';
                  trayInput.style.borderColor = '#28a745';

                  const errorSpan = trayInput.parentElement.querySelector('.rejection-tray-error');
                  if (errorSpan) {
                      errorSpan.innerHTML = '‚úÖ Valid for re-use - Perfect capacity match';
                      errorSpan.style.display = 'block';
                      errorSpan.style.color = '#155724';
                      errorSpan.style.backgroundColor = '#d4edda';
                      errorSpan.style.border = '1px solid #c3e6cb';
                      errorSpan.style.padding = '4px 6px';
                      errorSpan.style.borderRadius = '3px';
                  }

                  // Test that validation preserves backend status
                  validateDuplicateTrayIds();
                  updateFormValidationState();

                  const preserved = trayInput._isBackendValidated === true &&
                                  trayInput.style.backgroundColor === 'rgb(212, 237, 218)';

                  return preserved;
              }

              // Initialize tests
              window.onload = function() {
                  setTimeout(() => {
                      displayResults();

                      // Add draft preservation test
                      const draftResult = testDraftLoading();
                      document.getElementById('test-summary').innerHTML += `
                          <div class="status ${draftResult ? 'success' : 'error'}">
                              <strong>Draft State Preservation: ${draftResult ? '‚úÖ PASS' : '‚ùå FAIL'}</strong>
                          </div>
                      `;
                  }, 100);
              };
    </script>
  </body>
</html>
